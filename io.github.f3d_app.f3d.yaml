app-id: io.github.f3d_app.f3d
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '21.08'
command: f3d
rename-desktop-file: f3d.desktop
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --filesystem=home
cleanup:
  - /include
  - /lib/cmake
  - /share/doc
  - /etc
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glew/glew.json

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'
  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_13_2.tar.gz
        sha256: 6b97168ce262d7f9fa67355171e8e1899989046bf70ca5735341b0872760af9a
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

        # OSPRay 1.8.0 need old version of TBB,
        # Could not build from source with make for some reason.
        # Only new TBB use CMake, we can build from source when OSPRay updates.
  #- name: TBB
    #buildsystem: simple
    ##no-autogen: true
    ##builddir: true
    #build-commands:
      #- make
      #- cd build/linux* && ls -l
      ##- ls -l
      #- stop
    #sources:
      #- type: archive
        #url: https://github.com/oneapi-src/oneTBB/archive/v2020.2.tar.gz
        #sha256: 4804320e1e6cbe3a5421997b52199e3c1a3829b2ecb6489641da4b8e32faf500
  - name: TBB
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/2019_U8.tar.gz
        sha256: 6b540118cbc79f9cbc06a35033c18156c21b84ab7b6cf56d773b168ad2b68566
      - type: patch
        path: tbb_cmake.patch

    # OSPRay 2.1.0 use Embree 3.9.0
    # ospray/scripts/superbuild/CMakeLists.txt
  - name: Embree
    buildsystem: cmake-ninja
    config-opts:
      - -DEMBREE_TUTORIALS:BOOL=OFF
      - -DEMBREE_ISPC_SUPPORT:BOOL=ON
      - -DEMBREE_TBB_INCLUDE_DIR=/app/include
      #- -DEMBREE_TBB_LIBRARY=/app/lib
      #- -DEMBREE_TBBMALLOC_LIBRARY=/app/lib
    sources:
      - type: archive
        url: https://github.com/embree/embree/archive/refs/tags/v3.9.0.tar.gz
        sha256: 53855e2ceb639289b20448ae9deab991151aa5f0bc7f9cc02f2af4dd6199d5d1
    modules:
      - name: extra-cmake-modules
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://invent.kde.org/frameworks/extra-cmake-modules.git
            tag: v5.98.0
        # Attempt to build from source, but ISPC need glic-32bit which make things complicated.
      - name: ISPC
        buildsystem: simple
        build-commands:
          - cp bin/ispc /app/bin/
        sources:
          - type: archive
            url: https://github.com/ispc/ispc/releases/download/v1.18.0/ispc-v1.18.0-linux.tar.gz
            sha256: 6c379bb97962e9de7d24fd48b3f7e647dc42be898e9d187948220268c646b692
      - name: glfw
        buildsystem: cmake-ninja
        config-opts:
          - -DGLFW_USE_WAYLAND:BOOL=ON
          - -DBUILD_SHARED_LIBS:BOOL=ON
          - -DGLFW_BUILD_EXAMPLES:BOOL=OFF
          - -DGLFW_BUILD_TESTS:BOOL=OFF
          - -DGLFW_BUILD_DOCS:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/glfw/glfw/releases/download/3.3.4/glfw-3.3.4.zip
            sha256: bbd2c42c660b725e9755eb417e40b373f0d4c03138c9b2e210d02cd308bd99cd

    # Can't build from source
  - name: OSPRay
    buildsystem: simple
    build-commands:
      - cp -rn bin/* /app/bin/
      - cp -rn include/* /app/include/
      - cp -rn lib/* /app/lib/
    sources:
      - type: archive
        url: https://github.com/ospray/ospray/releases/download/v2.1.0/ospray-2.1.0.x86_64.linux.tar.gz
        sha256: 23ac9ab5e279392499c7598b4513c4c717708778c311c35681e1b90e95512790
    modules:
      - name: ospcommon
        buildsystem: cmake
        builddir: true
        #config-opts:
          #- -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/ospray/ospcommon/archive/refs/tags/v1.3.1.tar.gz
            sha256: 1c043c4a09e68fb7319db61f28a5830fc09f1457b24155a42b5f7c6421bcca73
      - name: openvkl
        buildsystem: simple
        build-commands:
          - cp -rn bin/* /app/bin/
          - cp -rn include/* /app/include/
          - cp -rn lib/* /app/lib/
        sources:
          - type: archive
            url: https://github.com/openvkl/openvkl/releases/download/v0.13.0/openvkl-0.13.0.x86_64.linux.tar.gz
            sha256: 8789334cf354105426151146b4c6de8968694ad781d7c24052a8df50ea4f11e0

    # When VTK update, update OSPRay, Embree, TBB, ISPC, and OpenImageDenoise too.
    # Needed OSPRay version can be found in vtk/Rendering/RayTracing/CMakeLists.txt
    # VTK 9.1 request ospray 2.1
  - name: VTK
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DBUILD_TESTING:BOOL=ON
      - -DVTK_BUILD_TESTING=ON
      #- -DVTK_USE_SYSTEM_ZLIB:BOOL=ON
      #- -DVTK_USE_SYSTEM_EIGEN:BOOL=ON
      #- -DVTK_BUILD_QT_DESIGNER_PLUGIN:BOOL=OFF
      - -DCMAKE_BUILD_TYPE=Release
      - -DVTK_LEGACY_REMOVE:BOOL=ON
    #- -DVTK_MODULE_ENABLE_VTK_RenderingRayTracing=WANT
    #- -DVTKOSPRAY_ENABLE_DENOISER:BOOL=ON
      - -DVTK_GROUP_ENABLE_Rendering=DEFAULT
      - -DVTK_GROUP_ENABLE_StandAlone=DEFAULT
      - -DVTK_MODULE_ENABLE_VTK_CommonSystem=YES
      - -DVTK_MODULE_ENABLE_VTK_FiltersGeneral=YES
      - -DVTK_MODULE_ENABLE_VTK_FiltersGeometry=YES
      - -DVTK_MODULE_ENABLE_VTK_ImagingCore=YES
      - -DVTK_MODULE_ENABLE_VTK_ImagingHybrid=YES
      - -DVTK_MODULE_ENABLE_VTK_InteractionStyle=YES
      - -DVTK_MODULE_ENABLE_VTK_InteractionWidgets=YES
      - -DVTK_MODULE_ENABLE_VTK_IOCityGML=YES
      - -DVTK_MODULE_ENABLE_VTK_IOExodus=YES
      - -DVTK_MODULE_ENABLE_VTK_IOGeometry=YES
      - -DVTK_MODULE_ENABLE_VTK_IOImage=YES
      - -DVTK_MODULE_ENABLE_VTK_IOImport=YES
      - -DVTK_MODULE_ENABLE_VTK_IOParallel=YES
      - -DVTK_MODULE_ENABLE_VTK_IOPLY=YES
      - -DVTK_MODULE_ENABLE_VTK_IOXML=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingAnnotation=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingCore=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingLabel=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingOpenGL2=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingVolumeOpenGL2=YES
      - -DVTK_MODULE_ENABLE_VTK_jsoncpp=YES
      - -DVTK_MODULE_ENABLE_VTK_TestingCore=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingRayTracing=YES
      - -DVTK_MODULE_ENABLE_VTK_opengl=YES
      - -DVTK_MODULE_ENABLE_VTK_RenderingExternal=YES
    sources:
      - type: archive
        url: https://www.vtk.org/files/release/9.2/VTK-9.2.0.rc2.tar.gz
        sha256: 276f35541a46ef5963ae6667ee60b9cb19c9dc5cb28ae68db71fd8577620b0fc
        x-checker-data:
          type: anitya
          project-id: 15084
          stable-only: true
          url-template: https://www.vtk.org/files/release/$major.$minor/VTK-$version.tar.gz
    #modules:
        # New version of OpenImageDenoise need new version of ISPC which we are using old ISPC.
      #- name: OpenImageDenoise
        #buildsystem: cmake
        #sources:
          #- type: archive
            #url: https://github.com/OpenImageDenoise/oidn/releases/download/v1.1.0/oidn-1.1.0.src.tar.gz
            #sha256: 4dd484abea8a0b3d12d346343fcb1ab7abef8f94318d8c537f69a20c2a75c4eb

  - name: Tcl
    buildsystem: autotools
    subdir: unix
    build-options:
      no-debuginfo: true
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tcl8.6.12-src.tar.gz
        sha256: 26c995dd0f167e48b11961d891ee555f680c175f7173ff8cb829f4ebcde4c1a6
        x-checker-data:
          type: anitya
          project-id: 4941
          stable-only: true
          url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz

  - name: tk
    subdir: unix
    build-options:
      no-debuginfo: true
    make-install-args:
      - install-private-headers
    cleanup:
      - /bin
      - /man
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tk8.6.12-src.tar.gz
        sha256: 12395c1f3fcb6bed2938689f797ea3cdf41ed5cb6c4766eec8ac949560310630
        x-checker-data:
          type: anitya
          project-id: 11426
          stable-only: true
          url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  - name: libXmu
    cleanup:
      - /share/doc
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libXmu-1.1.3.tar.gz
        sha256: 5bd9d4ed1ceaac9ea023d86bf1c1632cd3b172dce4a193a72a94e1d9df87a62e
        x-checker-data:
          type: anitya
          project-id: 1785
          stable-only: true
          url-template: https://www.x.org/archive/individual/lib/libXmu-$version.tar.gz

  - name: OCCT
    buildsystem: cmake-ninja
    config-opts:
      - -D3RDPARTY_TK_INCLUDE_DIR:PATH=/app/include
    sources:
      - type: git
        url: https://github.com/Open-Cascade-SAS/OCCT.git
        tag: V7_6_3
        commit: b079fb9877ef64d4a8158a60fa157f59b096debb
        x-checker-data:
          type: git
          tag-pattern: ^(V[\d._]+)$

  - name: assimp
    buildsystem: cmake-ninja
    config-opts:
      - -DASSIMP_BUILD_ASSIMP_TOOLS:BOOL=NO
      - -DASSIMP_BUILD_TESTS:BOOL=NO
    sources:
      - type: archive
        url: https://github.com/assimp/assimp/archive/v5.0.1.tar.gz
        sha256: 11310ec1f2ad2cd46b95ba88faca8f7aaa1efe9aa12605c55e3de2b977b3dbfc
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

    # Move config.json as upstream request.
  - name: F3D
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DBUILD_TESTING:BOOL=OFF
      - -DF3D_INSTALL_DEFAULT_CONFIGURATION_FILE:BOOL=ON
      - -DF3D_MODULE_EXODUS:BOOL=ON
      - -DF3D_MODULE_RAYTRACING:BOOL=OFF
      - -DF3D_MODULE_OCCT:BOOL=ON
      - -DF3D_MODULE_ASSIMP:BOOL=ON
      - -DF3D_MODULE_ALEMBIC:BOOL=ON
    post-install:
      - mv /app/etc/f3d/config.json /app/config.json
      - install -Dm644 resources/logo.svg /app/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg
      - desktop-file-edit --set-key=Icon --set-value=$FLATPAK_ID /app/share/applications/f3d.desktop
      - install -Dm644 resources/$FLATPAK_ID.metainfo.xml /app/share/metainfo/$FLATPAK_ID.metainfo.xml
    sources:
      - type: archive
        url: https://github.com/f3d-app/f3d/archive/refs/tags/v1.3.1.tar.gz
        sha256: 653dc4044e14d0618c1d947a8ee85d2513e100b3fc24bd6e51830131a13e795d
        x-checker-data:
          type: anitya
          project-id: 224911
          stable-only: true
          url-template: https://github.com/f3d-app/f3d/archive/refs/tags/v$version.tar.gz
      - type: patch
        path: fix_metainfo.patch
      - type: patch
        path: remove_stdc++fs.patch
